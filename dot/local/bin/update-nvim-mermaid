#!/usr/bin/env bash
# Update Mermaid.js in markdown-preview.nvim plugin to the latest version

set -e

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Plugin directory
PLUGIN_DIR="$HOME/.local/share/nvim/lazy/markdown-preview.nvim"
STATIC_DIR="$PLUGIN_DIR/app/_static"
MERMAID_FILE="$STATIC_DIR/mermaid.min.js"

# Check if plugin directory exists
if [ ! -d "$PLUGIN_DIR" ]; then
    echo -e "${RED}Error: markdown-preview.nvim plugin not found at $PLUGIN_DIR${NC}"
    exit 1
fi

# Get latest Mermaid version
echo -e "${YELLOW}Checking latest Mermaid.js version...${NC}"
LATEST_VERSION=$(curl -s https://registry.npmjs.org/mermaid/latest | grep -o '"version":"[^"]*"' | cut -d'"' -f4)

if [ -z "$LATEST_VERSION" ]; then
    echo -e "${RED}Error: Failed to fetch latest Mermaid version${NC}"
    exit 1
fi

echo -e "${GREEN}Latest Mermaid.js version: $LATEST_VERSION${NC}"

# Check current version (if possible)
if [ -f "$MERMAID_FILE" ]; then
    CURRENT_SIZE=$(ls -lh "$MERMAID_FILE" | awk '{print $5}')
    echo -e "${YELLOW}Current mermaid.min.js size: $CURRENT_SIZE${NC}"
fi

# Confirm update
read -p "Update to Mermaid.js v$LATEST_VERSION? (y/N) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Update cancelled."
    exit 0
fi

# Download new version
echo -e "${YELLOW}Downloading Mermaid.js v$LATEST_VERSION...${NC}"
TMP_FILE=$(mktemp)
if ! curl -L -o "$TMP_FILE" "https://cdn.jsdelivr.net/npm/mermaid@$LATEST_VERSION/dist/mermaid.min.js"; then
    echo -e "${RED}Error: Failed to download Mermaid.js${NC}"
    rm -f "$TMP_FILE"
    exit 1
fi

# Verify download
if [ ! -s "$TMP_FILE" ]; then
    echo -e "${RED}Error: Downloaded file is empty${NC}"
    rm -f "$TMP_FILE"
    exit 1
fi

NEW_SIZE=$(ls -lh "$TMP_FILE" | awk '{print $5}')
echo -e "${GREEN}Downloaded successfully ($NEW_SIZE)${NC}"

# Backup old version
if [ -f "$MERMAID_FILE" ]; then
    BACKUP_FILE="$MERMAID_FILE.backup-$(date +%Y%m%d-%H%M%S)"
    echo -e "${YELLOW}Backing up current version to: $BACKUP_FILE${NC}"
    cp "$MERMAID_FILE" "$BACKUP_FILE"
fi

# Replace with new version
echo -e "${YELLOW}Installing new version...${NC}"
mv "$TMP_FILE" "$MERMAID_FILE"

echo -e "${GREEN}âœ“ Mermaid.js successfully updated to v$LATEST_VERSION${NC}"
echo -e "${YELLOW}Note: Restart Neovim and run :MarkdownPreview to see the changes${NC}"

# Optional: Show backup location
if [ -n "$BACKUP_FILE" ]; then
    echo -e "${YELLOW}Backup saved at: $BACKUP_FILE${NC}"
fi
