#!/bin/bash
# Script to setup my Working Environment.
# Sriharsha Mucheli : harshasrisri@gmail.com

main() {
	root_dir=$PWD
	home_dir=$HOME
	dot_dir="$root_dir/dot"
	vim_dir="$dot_dir/vim"

	if [ ! -e $dot_dir ]; then fatal "No $dot_dir!! Please \"git pull\" or \"git clone\" again."; fi

	case $1 in
		update ) 
			update
			;;
		install )
			plug
			bkup
			make_links
			myshrc
			;;

		restore ) restore
			;;

		* ) echo "Usage : $0 [install | restore | update]"
			;;
	esac
}

plug () {
	vimPlug_path="$vim_dir/autoload/plug.vim"
	vimPlug_url="https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim"
	which curl &> /dev/null
	[ $? -eq "0" ] && [ ! -e $vimPlug_path ] && curl -fLo $vimPlug_path --create-dirs $vimPlug_url
	which wget &> /dev/null
	[ $? -eq "0" ] && [ ! -e $vimPlug_path ] && wget --force-directories -O $vimPlug_path $vimPlug_url
	[ ! -e $vimPlug_path ] && fatal "Vim Plug installation failed. Aborting."
	vim +PlugInstall +qa!
}

bkup () {
	BackupDir="$root_dir/.bkup"

	if [ -d $BackupDir ]; then 
		echo "Backup already present";
		return; 
	fi

	mkdir -p $BackupDir
	echo -n "Back up start... "

	for i in $(ls $dot_dir); do
		if [ -e $BackupDir/$i ]; then continue; fi

		if [ -e $home_dir/.$i ]; then
			echo -n "$i "
			mv $home_dir/.$i $BackupDir/$i
		fi
	done

	echo "... Done!"
}

myshrc () {
	for i in bashrc fishrc; do
		if [ -e "$HOME/.$i" ]; then
			grep myshrc $HOME/.$i &> /dev/null
			if [ $? -eq "0" ]; then continue; fi
			echo "source $HOME/.myshrc" >> $HOME/.$i
		fi
	done
}

make_links () {
	echo -n "Copying files... "

	for i in $(ls $dot_dir/); do
		echo -n "$home_dir/.$i "
		ln -sf $dot_dir/$i $home_dir/.$i
	done

	echo "... Done!"
}

restore() {
	if [ ! -e $BackupDir ]; then
		echo "No backups present!!"
		exit
	fi

	shopt -s dotglob

	for i in $(ls $dot_dir); do
		rm $home_dir/.$i
		mv $BackupDir/$i $home_dir/.$i
	done

	rm -rf $BackupDir
	echo "Reset Complete. Back to your old Setup!"
}

update() {
	echo -n "Updating Repo . . . "
	git pull
	echo " Done"
	echo -n "Updating vim plugins . . . "
	vim +PlugUpdate +qa!
	echo " Done"
}

fatal () {
	echo -n "FATAL: "
	echo $1 >3
	exit
}

main $@
