#!/bin/bash
# Script to setup my Working Environment.
# Sriharsha Mucheli : harshasrisri@gmail.com

install_vim_plugins() {
	vimPlug_path="$vim_dir/autoload/plug.vim"
	vimPlug_url="https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim"

	which curl &> /dev/null
	[ $? -eq "0" ] && [ ! -e $vimPlug_path ] && curl -fLo $vimPlug_path --create-dirs $vimPlug_url

	which wget &> /dev/null
	[ $? -eq "0" ] && [ ! -e $vimPlug_path ] && wget --force-directories -O $vimPlug_path $vimPlug_url

	[ ! -e $vimPlug_path ] && fatal "Vim Plug installation failed. Aborting."

	echo -n "Updating vim plugins . . . "
	vim +PlugUpdate +qa!
	echo " Done"
}

install_tmux_plugins () {
    export tpm_path="$tmux_dir/plugins/tpm"
    if [ -e ${tpm_path} ]; then
        git -C ${tpm_path} pull --quiet
        echo -n "updating tmux plugins: " && ${tpm_path}/bin/update_plugins all
    else
        git clone https://github.com/tmux-plugins/tpm ${tpm_path} --quiet
        echo -n "installing tmux plugins: " && ${tpm_path}/bin/install_plugins
    fi
}

myshrc () {
	for i in bashrc fishrc; do
		if [ -e "$HOME/.$i" ]; then
			grep myshrc $HOME/.$i &> /dev/null
			if [ $? -eq "0" ]; then continue; fi
			echo "source $HOME/.myshrc" >> $HOME/.$i
		fi
	done
}

make_links () {
    mkdir -p $vim_dir $tmux_dir
	echo -n "Linking files... "

	for i in $(ls $dot_dir/); do
		echo -n "$HOME/.$i "
		ln -snf $dot_dir/$i $HOME/.$i
	done

	echo "... Done!"
}

fatal () {
	echo -n "FATAL: "
	echo $1 >3
	exit
}

main() {
	root_dir=$PWD
	dot_dir="$root_dir/dot"
	vim_dir="$dot_dir/vim"
	tmux_dir="$dot_dir/tmux"

	echo -n "Updating Repo . . . " && git pull --quiet && echo " Done"
	if [ ! -e $dot_dir ]; then fatal "No $dot_dir!! Please \"git pull\" or \"git clone\" again."; fi

    make_links

    install_vim_plugins
    install_tmux_plugins
    myshrc
}

pushd $(dirname $0) &> /dev/null
main $@
popd &> /dev/null
