#!/bin/bash
# Script to setup my Working Environment.
# Sriharsha Mucheli : harshasrisri@gmail.com

main() {
	root_dir=$PWD
	home_dir=$HOME
	dot_dir="$root_dir/dot"
	vim_dir="$dot_dir/vim"

	if [ ! -e $dot_dir ]; then fatal "No $dot_dir!! Please \"git pull\" or \"git clone\" again."; fi

	case $1 in
		install )
			submodules
			pathogen
			bkup
			make_links
			;;

		reset ) reset
			;;

		update ) 
			update
			bkup
			make_links
			;;

		* ) echo "Usage : $0 [install | reset | update]"
			;;
	esac
}

submodules () {
	mkdir -p $vim_dir/bundle
	echo -n "Installing Plugins . . . "

	while read line; do
		plugin=${line##*/}
		if [ -d $vim_dir/bundle/$plugin ]; then continue; fi
		echo -n "$plugin "
		git submodule add --quiet --force $line $vim_dir/bundle/$plugin &> /dev/null
	done < $root_dir/plugin_list

	echo "Done!"
}

pathogen () {
	echo -n "Setting up Pathogen . . . "
	git submodule add --quiet --force http://github.com/tpope/vim-pathogen $vim_dir/Pathogen &> /dev/null
	mkdir -p $vim_dir/autoload 
	ln --force $vim_dir/Pathogen/autoload/pathogen.vim $vim_dir/autoload/pathogen.vim
	echo "Done!"
}

bkup () {
	BackupDir="$root_dir/.bkup"

	mkdir -p $BackupDir
	echo -n "Back up start... "

	for i in $(ls $dot_dir); do
		if [ -e $BackupDir/$i ]; then continue; fi

		if [ -e $home_dir/.$i ]; then
			echo -n "$i "
			mv $home_dir/.$i $BackupDir
		fi
	done

	echo "... Done!"
}

make_links () {
	echo -n "Copying files... "

	for i in $(ls $dot_dir/); do
		echo -n "$home_dir/.$i "
		ln -sf $dot_dir/$i $home_dir/.$i
	done

	echo "... Done!"
}

reset() {
	if [ ! -e $BackupDir ]; then
		echo "No backups present!!"
		exit
	fi

	shopt -s dotglob

	for i in $(ls $dot_dir); do
		rm $home_dir/.$i
		mv $BackupDir/.$i $home_dir/
	done

	rm -rf $BackupDir
	echo "Reset Complete. Back to your old Setup!"
}

update() {
	git pull
	git submodule foreach git pull origin master
}

fatal () {
	echo -n "FATAL: "
	echo $1 >3
	exit
}

main $@
